<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á∫¢ÈªëÊ†ëÂèØËßÜÂåñ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .control-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        input[type="number"] {
            padding: 12px 20px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            width: 150px;
            transition: all 0.3s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-2px);
        }

        .presets {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .preset-btn {
            padding: 8px 15px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .preset-btn:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .canvas-container {
            flex: 1;
            padding: 40px;
            background: white;
            overflow-x: auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #treeCanvas {
            display: block;
        }

        .steps-panel {
            width: 400px;
            background: #f8f9fa;
            border-left: 2px solid #e9ecef;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 80px);
        }

        .steps-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .steps-header h3 {
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .steps-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .step-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease;
        }

        .step-item.current {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .step-item.highlight {
            animation: pulse 0.5s ease;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 10px;
        }

        .step-item.current .step-number {
            background: #28a745;
        }

        .step-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .step-description {
            color: #555;
            line-height: 1.6;
            font-size: 0.95em;
        }

        .legend {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid;
        }

        .legend-red {
            background: #ff4757;
            border-color: #ff1744;
        }

        .legend-black {
            background: #2f3542;
            border-color: #333;
        }

        .info-panel {
            padding: 30px;
            background: #f8f9fa;
            border-top: 2px solid #e9ecef;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .info-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .info-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .info-card p {
            color: #495057;
            line-height: 1.6;
        }

        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            animation: slideInMsg 0.3s ease;
        }

        @keyframes slideInMsg {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .message.success {
            border-left: 4px solid #28a745;
            color: #28a745;
        }

        .message.error {
            border-left: 4px solid #dc3545;
            color: #dc3545;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .speed-control label {
            font-weight: 600;
            color: #495057;
        }

        .speed-control input[type="range"] {
            width: 150px;
        }

        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            .steps-panel {
                width: 100%;
                max-height: 350px;
                border-left: none;
                border-top: 2px solid #e9ecef;
            }
            .steps-content {
                overflow-y: auto; 
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå≥ Á∫¢ÈªëÊ†ëÂèØËßÜÂåñ</h1>
            <p>‰∫§‰∫íÂºèÁ∫¢ÈªëÊ†ëÊï∞ÊçÆÁªìÊûÑÊºîÁ§∫ - ÊîØÊåÅÊèíÂÖ•ÂíåÂà†Èô§Êìç‰Ωú</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <div class="input-group">
                    <input type="number" id="valueInput" placeholder="ËæìÂÖ•Êï∞ÂÄº" min="1" max="999">
                    <button class="btn-primary" id="insertBtn" onclick="insertValue()">ÊèíÂÖ•ËäÇÁÇπ</button>
                    <button class="btn-warning" id="deleteBtn" onclick="deleteValue()">Âà†Èô§ËäÇÁÇπ</button>
                </div>
                <div class="speed-control">
                    <label>Âä®ÁîªÈÄüÂ∫¶:</label>
                    <input type="range" id="speedSlider" min="100" max="2000" value="1000" step="100">
                    <span id="speedLabel">1.0s</span>
                </div>
                <button class="btn-secondary" id="clearBtn" onclick="clearTree()">Ê∏ÖÁ©∫Ê†ë</button>
                <button class="btn-danger" id="randomBtn" onclick="randomTree()">ÈöèÊú∫ÁîüÊàê</button>
            </div>

            <div class="presets">
                <span style="color: #6c757d; font-weight: 600;">È¢ÑËÆæÁ§∫‰æãÔºö</span>
                <button class="preset-btn" onclick="loadPreset([10, 20, 30, 15, 25, 40, 50])">Á§∫‰æã1</button>
                <button class="preset-btn" onclick="loadPreset([7, 3, 18, 10, 22, 8, 11, 26])">Á§∫‰æã2</button>
                <button class="preset-btn" onclick="loadPreset([1, 2, 3, 4, 5, 6, 7, 8, 9])">È°∫Â∫èÊèíÂÖ•</button>
                <button class="preset-btn" onclick="loadPreset([50, 40, 30, 20, 10])">ÈÄÜÂ∫èÊèíÂÖ•</button>
            </div>

            <!-- <div class="legend">
                <div class="legend-item">
                    <div class="legend-circle legend-red"></div>
                    <span>Á∫¢Ëâ≤ËäÇÁÇπ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle legend-black"></div>
                    <span>ÈªëËâ≤ËäÇÁÇπ</span>
                </div>
            </div> -->
        </div>

        <div class="main-content">
            <div class="canvas-container">
                <canvas id="treeCanvas"></canvas>
            </div>

            <div class="steps-panel">
                <div class="steps-header">
                    <h4>üìã Êìç‰ΩúÊ≠•È™§</h4>
                </div>
                <div class="steps-content" id="stepsContent">
                    <div style="text-align: center; color: #6c757d; padding: 40px 20px;">
                        <p style="font-size: 1.2em; margin-bottom: 15px;">üëã Ê¨¢Ëøé‰ΩøÁî®Á∫¢ÈªëÊ†ëÂèØËßÜÂåñÂ∑•ÂÖ∑</p>
                        <p>üëà ËæìÂÖ•Êï∞ÂÄºÔºåÂèØ‰ª•ÊèíÂÖ•ÊàñÂà†Èô§ËäÇÁÇπ</p>
                        <p style="margin-top: 10px;">Êàñ‰ΩøÁî®È¢ÑËÆæÁ§∫‰æãÂø´ÈÄüÂºÄÂßã</p>
                        <p style="margin-top: 10px;">ËøôÈáå‰ºöÊòæÁ§∫ÊØè‰∏ÄÊ≠•ÁöÑËØ¶ÁªÜÊìç‰ΩúËØ¥Êòé</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-panel">
            <div class="info-grid">
                <div class="info-card">
                    <h3>üìä Ê†ëÁöÑÁªüËÆ°</h3>
                    <p id="treeStats">ËäÇÁÇπÊï∞: 0<br>Ê†ëÈ´ò: 0<br>ÈªëÈ´ò: 0</p>
                </div>
                <div class="info-card">
                    <h3>üìñ Á∫¢ÈªëÊ†ëÊÄßË¥®</h3>
                    <p>
                        1. ÊØè‰∏™ËäÇÁÇπÊòØÁ∫¢Ëâ≤ÊàñÈªëËâ≤<br>
                        2. Ê†πËäÇÁÇπÊòØÈªëËâ≤<br>
                        3. ÊâÄÊúâÂè∂Â≠êËäÇÁÇπÊòØÈªëËâ≤<br>
                        4. Á∫¢Ëâ≤ËäÇÁÇπÁöÑÂ≠êËäÇÁÇπÂøÖÈ°ªÊòØÈªëËâ≤<br>
                        5. ‰ªéÊ†πÂà∞Âè∂Â≠êÁöÑÊâÄÊúâË∑ØÂæÑÂåÖÂê´Áõ∏ÂêåÊï∞ÈáèÁöÑÈªëËâ≤ËäÇÁÇπ
                    </p>
                </div>
                <div class="info-card">
                    <h3>üéØ Êìç‰ΩúËØ¥Êòé</h3>
                    <p>
                        ‚Ä¢ ËæìÂÖ•Êï∞ÂÄºÂêéÂèØ‰ª•ÊèíÂÖ•ÊàñÂà†Èô§ËäÇÁÇπ<br>
                        ‚Ä¢ ËßÇÂØüÂè≥‰æßËØ¶ÁªÜÁöÑÊìç‰ΩúÊ≠•È™§ËØ¥Êòé<br>
                        ‚Ä¢ Ë∞ÉÊï¥Âä®ÁîªÈÄüÂ∫¶ÊéßÂà∂ËßÇÁúãËäÇÂ•è<br>
                        ‚Ä¢ ‰ΩøÁî®È¢ÑËÆæÁ§∫‰æãÂø´ÈÄü‰ΩìÈ™å
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="message" class="message"></div>

    <script>
        // Á∫¢ÈªëÊ†ëËäÇÁÇπÂÆö‰πâ
        const RED = true;
        const BLACK = false;

        class Node {
            constructor(val) {
                this.val = val;
                this.color = RED;
                this.left = null;
                this.right = null;
                this.parent = null;
            }

            clone() {
                const newNode = new Node(this.val);
                newNode.color = this.color;
                if (this.left) {
                    newNode.left = this.left.clone();
                    newNode.left.parent = newNode;
                }
                if (this.right) {
                    newNode.right = this.right.clone();
                    newNode.right.parent = newNode;
                }
                return newNode;
            }
        }

        // Êìç‰ΩúÊ≠•È™§ËÆ∞ÂΩï
        let animationSteps = [];
        let animationSpeed = 1000;
        let isAnimating = false;

        class RBTree {
            constructor() {
                this.root = null;
            }

            cloneTree() {
                const newTree = new RBTree();
                if (this.root) {
                    newTree.root = this.root.clone();
                }
                return newTree;
            }

            rotateLeft(x) {
                const y = x.right;
                x.right = y.left;
                if (y.left) y.left.parent = x;

                y.parent = x.parent;
                if (!x.parent) this.root = y;
                else if (x === x.parent.left) x.parent.left = y;
                else x.parent.right = y;

                y.left = x;
                x.parent = y;
            }

            rotateRight(x) {
                const y = x.left;
                x.left = y.right;
                if (y.right) y.right.parent = x;

                y.parent = x.parent;
                if (!x.parent) this.root = y;
                else if (x === x.parent.left) x.parent.left = y;
                else x.parent.right = y;

                y.right = x;
                x.parent = y;
            }

            // ÊèíÂÖ•‰øÆÂ§ç
            insertFix(z) {
                while (z.parent && z.parent.color === RED) {
                    if (z.parent === z.parent.parent.left) {
                        const y = z.parent.parent.right;
                        if (y && y.color === RED) {
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `ÊÉÖÂÜµ1ÔºöÁà∂ËäÇÁÇπ${z.parent.val}ÂíåÂèîËäÇÁÇπ${y.val}ÈÉΩÊòØÁ∫¢Ëâ≤`,
                                detail: `ËøùÂèç‰∫ÜÊÄßË¥®4ÔºàÁ∫¢Ëâ≤ËäÇÁÇπÁöÑÂ≠êËäÇÁÇπÂøÖÈ°ªÊòØÈªëËâ≤Ôºâ„ÄÇÈúÄË¶ÅÈáçÊñ∞ÁùÄËâ≤ÔºöÁà∂ËäÇÁÇπ${z.parent.val}‚ÜíÈªëËâ≤ÔºåÂèîËäÇÁÇπ${y.val}‚ÜíÈªëËâ≤ÔºåÁ•ñÁà∂ËäÇÁÇπ${z.parent.parent.val}‚ÜíÁ∫¢Ëâ≤ÔºåÁÑ∂ÂêéÁªßÁª≠Âêë‰∏äË∞ÉÊï¥„ÄÇ`,
                                highlightNodes: [z.val, z.parent.val, y.val, z.parent.parent.val]
                            });
                            
                            z.parent.color = BLACK;
                            y.color = BLACK;
                            z.parent.parent.color = RED;
                            
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `ÂèòËâ≤ÂÆåÊàê`,
                                detail: `Áà∂ËäÇÁÇπ${z.parent.val}ÂíåÂèîËäÇÁÇπ${y.val}Â∑≤Âèò‰∏∫ÈªëËâ≤ÔºåÁ•ñÁà∂ËäÇÁÇπ${z.parent.parent.val}Âèò‰∏∫Á∫¢Ëâ≤„ÄÇÁªßÁª≠Âêë‰∏äÊ£ÄÊü•Á•ñÁà∂ËäÇÁÇπ„ÄÇ`,
                                highlightNodes: [z.parent.parent.val]
                            });
                            
                            z = z.parent.parent;
                        } else {
                            if (z === z.parent.right) {
                                animationSteps.push({
                                    tree: this.cloneTree(),
                                    description: `ÊÉÖÂÜµ3-LRÔºöËäÇÁÇπ${z.val}ÊòØÁà∂ËäÇÁÇπ${z.parent.val}ÁöÑÂè≥Â≠©Â≠êÔºåÂèîËäÇÁÇπÊòØÈªëËâ≤`,
                                    detail: `ËøôÊòØ‰∏Ä‰∏™"‰πãÂ≠óÂΩ¢"ÁªìÊûÑÔºåÈúÄË¶ÅÂÖàËΩ¨Êç¢‰∏∫"‰∏ÄÂ≠óÂΩ¢"„ÄÇÂØπÁà∂ËäÇÁÇπ${z.parent.val}ËøõË°åÂ∑¶ÊóãÔºåÂ∞ÜÊÉÖÂÜµËΩ¨Êç¢‰∏∫LL„ÄÇ`,
                                    highlightNodes: [z.val, z.parent.val]
                                });
                                
                                z = z.parent;
                                this.rotateLeft(z);
                                
                                animationSteps.push({
                                    tree: this.cloneTree(),
                                    description: `Â∑¶ÊóãÂÆåÊàêÔºåËΩ¨Êç¢‰∏∫LLÊÉÖÂÜµ`,
                                    detail: `Áé∞Âú®ËäÇÁÇπ${z.val}„ÄÅ${z.parent.val}„ÄÅ${z.parent.parent.val}ÂΩ¢Êàê‰∫Ü‰∏ÄÂ≠óÂΩ¢ÁªìÊûÑÔºåÂèØ‰ª•ËøõË°åLLÁöÑÂ§ÑÁêÜ„ÄÇ`,
                                    highlightNodes: [z.val, z.parent.val, z.parent.parent.val]
                                });
                            } else {
                                animationSteps.push({
                                    tree: this.cloneTree(),
                                    description: `ÊÉÖÂÜµ2-LLÔºöËäÇÁÇπ${z.val}ÊòØÁà∂ËäÇÁÇπ${z.parent.val}ÁöÑÂ∑¶Â≠©Â≠êÔºåÂèîËäÇÁÇπÊòØÈªëËâ≤`,
                                    detail: `ËøôÊòØ‰∏Ä‰∏™"‰∏ÄÂ≠óÂΩ¢"ÁªìÊûÑ„ÄÇÈúÄË¶ÅÔºö1) Áà∂ËäÇÁÇπ${z.parent.val}‚ÜíÈªëËâ≤Ôºå2) Á•ñÁà∂ËäÇÁÇπ${z.parent.parent.val}‚ÜíÁ∫¢Ëâ≤Ôºå3) ÂØπÁ•ñÁà∂ËäÇÁÇπÂè≥Êóã„ÄÇ`,
                                    highlightNodes: [z.val, z.parent.val, z.parent.parent.val]
                                });
                            }
                            
                            z.parent.color = BLACK;
                            z.parent.parent.color = RED;
                            
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `ÂèòËâ≤ÂÆåÊàê`,
                                detail: `Áà∂ËäÇÁÇπ${z.parent.val}Âèò‰∏∫ÈªëËâ≤ÔºåÁ•ñÁà∂ËäÇÁÇπ${z.parent.parent.val}Âèò‰∏∫Á∫¢Ëâ≤„ÄÇÊé•‰∏ãÊù•ÂØπÁ•ñÁà∂ËäÇÁÇπËøõË°åÂè≥Êóã„ÄÇ`,
                                highlightNodes: [z.parent.val, z.parent.parent.val]
                            });
                            
                            this.rotateRight(z.parent.parent);
                            
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `Âè≥ÊóãÂÆåÊàê`,
                                detail: `ÂØπËäÇÁÇπËøõË°åÂè≥ÊóãÔºåË∞ÉÊï¥ÂÆåÊàê„ÄÇÁé∞Âú®Êª°Ë∂≥ÊâÄÊúâÁ∫¢ÈªëÊ†ëÊÄßË¥®„ÄÇ`,
                                highlightNodes: [z.parent.val]
                            });
                        }
                    } else {
                        const y = z.parent.parent.left;
                        if (y && y.color === RED) {
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `ÊÉÖÂÜµ1ÔºöÁà∂ËäÇÁÇπ${z.parent.val}ÂíåÂèîËäÇÁÇπ${y.val}ÈÉΩÊòØÁ∫¢Ëâ≤`,
                                detail: `ËøùÂèç‰∫ÜÊÄßË¥®4ÔºàÁ∫¢Ëâ≤ËäÇÁÇπÁöÑÂ≠êËäÇÁÇπÂøÖÈ°ªÊòØÈªëËâ≤Ôºâ„ÄÇÈúÄË¶ÅÈáçÊñ∞ÁùÄËâ≤ÔºöÁà∂ËäÇÁÇπ${z.parent.val}‚ÜíÈªëËâ≤ÔºåÂèîËäÇÁÇπ${y.val}‚ÜíÈªëËâ≤ÔºåÁ•ñÁà∂ËäÇÁÇπ${z.parent.parent.val}‚ÜíÁ∫¢Ëâ≤ÔºåÁÑ∂ÂêéÁªßÁª≠Âêë‰∏äË∞ÉÊï¥„ÄÇ`,
                                highlightNodes: [z.val, z.parent.val, y.val, z.parent.parent.val]
                            });
                            
                            z.parent.color = BLACK;
                            y.color = BLACK;
                            z.parent.parent.color = RED;
                            
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `ÂèòËâ≤ÂÆåÊàê`,
                                detail: `Áà∂ËäÇÁÇπ${z.parent.val}ÂíåÂèîËäÇÁÇπ${y.val}Â∑≤Âèò‰∏∫ÈªëËâ≤ÔºåÁ•ñÁà∂ËäÇÁÇπ${z.parent.parent.val}Âèò‰∏∫Á∫¢Ëâ≤„ÄÇÁªßÁª≠Âêë‰∏äÊ£ÄÊü•Á•ñÁà∂ËäÇÁÇπ„ÄÇ`,
                                highlightNodes: [z.parent.parent.val]
                            });
                            
                            z = z.parent.parent;
                        } else {
                            if (z === z.parent.left) {
                                animationSteps.push({
                                    tree: this.cloneTree(),
                                    description: `ÊÉÖÂÜµ3-RLÔºöËäÇÁÇπ${z.val}ÊòØÁà∂ËäÇÁÇπ${z.parent.val}ÁöÑÂ∑¶Â≠©Â≠êÔºåÂèîËäÇÁÇπÊòØÈªëËâ≤`,
                                    detail: `ËøôÊòØ‰∏Ä‰∏™"‰πãÂ≠óÂΩ¢"ÁªìÊûÑÔºåÈúÄË¶ÅÂÖàËΩ¨Êç¢‰∏∫"‰∏ÄÂ≠óÂΩ¢"„ÄÇÂØπÁà∂ËäÇÁÇπ${z.parent.val}ËøõË°åÂè≥ÊóãÔºåÂ∞ÜÊÉÖÂÜµËΩ¨Êç¢‰∏∫RR„ÄÇ`,
                                    highlightNodes: [z.val, z.parent.val]
                                });
                                
                                z = z.parent;
                                this.rotateRight(z);
                                
                                animationSteps.push({
                                    tree: this.cloneTree(),
                                    description: `Âè≥ÊóãÂÆåÊàêÔºåËΩ¨Êç¢‰∏∫RRÊÉÖÂÜµ`,
                                    detail: `Áé∞Âú®ËäÇÁÇπ${z.val}„ÄÅ${z.parent.val}„ÄÅ${z.parent.parent.val}ÂΩ¢Êàê‰∫Ü‰∏ÄÂ≠óÂΩ¢ÁªìÊûÑÔºåÂèØ‰ª•ËøõË°åRRÁöÑÂ§ÑÁêÜ„ÄÇ`,
                                    highlightNodes: [z.val, z.parent.val, z.parent.parent.val]
                                });
                            } else {
                                animationSteps.push({
                                    tree: this.cloneTree(),
                                    description: `ÊÉÖÂÜµ2-RRÔºöËäÇÁÇπ${z.val}ÊòØÁà∂ËäÇÁÇπ${z.parent.val}ÁöÑÂè≥Â≠©Â≠êÔºåÂèîËäÇÁÇπÊòØÈªëËâ≤`,
                                    detail: `ËøôÊòØ‰∏Ä‰∏™"‰∏ÄÂ≠óÂΩ¢"ÁªìÊûÑ„ÄÇÈúÄË¶ÅÔºö1) Áà∂ËäÇÁÇπ${z.parent.val}‚ÜíÈªëËâ≤Ôºå2) Á•ñÁà∂ËäÇÁÇπ${z.parent.parent.val}‚ÜíÁ∫¢Ëâ≤Ôºå3) ÂØπÁ•ñÁà∂ËäÇÁÇπÂ∑¶Êóã„ÄÇ`,
                                    highlightNodes: [z.val, z.parent.val, z.parent.parent.val]
                                });
                            }
                            
                            z.parent.color = BLACK;
                            z.parent.parent.color = RED;
                            
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `ÂèòËâ≤ÂÆåÊàê`,
                                detail: `Áà∂ËäÇÁÇπ${z.parent.val}Âèò‰∏∫ÈªëËâ≤ÔºåÁ•ñÁà∂ËäÇÁÇπ${z.parent.parent.val}Âèò‰∏∫Á∫¢Ëâ≤„ÄÇÊé•‰∏ãÊù•ÂØπÁ•ñÁà∂ËäÇÁÇπËøõË°åÂ∑¶Êóã„ÄÇ`,
                                highlightNodes: [z.parent.val, z.parent.parent.val]
                            });
                            
                            this.rotateLeft(z.parent.parent);
                            
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `Â∑¶ÊóãÂÆåÊàê`,
                                detail: `ÂØπËäÇÁÇπËøõË°åÂ∑¶ÊóãÔºåË∞ÉÊï¥ÂÆåÊàê„ÄÇÁé∞Âú®Êª°Ë∂≥ÊâÄÊúâÁ∫¢ÈªëÊ†ëÊÄßË¥®„ÄÇ`,
                                highlightNodes: [z.parent.val]
                            });
                        }
                    }
                }
                
                if (this.root.color === RED) {
                    animationSteps.push({
                        tree: this.cloneTree(),
                        description: `Ê†πËäÇÁÇπÈúÄË¶ÅÂèò‰∏∫ÈªëËâ≤`,
                        detail: `Ê†πËäÇÁÇπ${this.root.val}ÂΩìÂâçÊòØÁ∫¢Ëâ≤ÔºåËøùÂèç‰∫ÜÊÄßË¥®2ÔºàÊ†πËäÇÁÇπÂøÖÈ°ªÊòØÈªëËâ≤Ôºâ„ÄÇÂ∞ÜÂÖ∂ÊüìÊàêÈªëËâ≤„ÄÇ`,
                        highlightNodes: [this.root.val]
                    });
                }
                
                this.root.color = BLACK;
                
                animationSteps.push({
                    tree: this.cloneTree(),
                    description: `ÊèíÂÖ•Ë∞ÉÊï¥ÂÆåÊàê`,
                    detail: `ÊâÄÊúâÁ∫¢ÈªëÊ†ëÊÄßË¥®Â∑≤Êª°Ë∂≥ÔºåÊèíÂÖ•Êìç‰ΩúÊàêÂäüÂÆåÊàêÔºÅ`,
                    highlightNodes: []
                });
            }

            // Âà†Èô§‰øÆÂ§ç
            deleteFix(x, xParent) {
                while (x !== this.root && (!x || x.color === BLACK)) {
                    if (x === xParent.left) {
                        let w = xParent.right;
                        
                        if (w && w.color === RED) {
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `ÊÉÖÂÜµ1ÔºöÂÖÑÂºüËäÇÁÇπ${w.val}ÊòØÁ∫¢Ëâ≤`,
                                detail: `Â∞ÜÂÖÑÂºü${w.val}ÂèòÈªëÔºåÁà∂ËäÇÁÇπ${xParent.val}ÂèòÁ∫¢ÔºåÁÑ∂ÂêéÂØπÁà∂ËäÇÁÇπÂ∑¶ÊóãÔºåËΩ¨Êç¢‰∏∫ÂÖ∂‰ªñÊÉÖÂÜµ„ÄÇ`,
                                highlightNodes: [w.val, xParent.val]
                            });
                            
                            w.color = BLACK;
                            xParent.color = RED;
                            this.rotateLeft(xParent);
                            w = xParent.right;
                            
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `ËΩ¨Êç¢ÂÆåÊàê`,
                                detail: `Áé∞Âú®ÂÖÑÂºüËäÇÁÇπÊòØÈªëËâ≤ÔºåÁªßÁª≠Â§ÑÁêÜ„ÄÇ`,
                                highlightNodes: [w.val]
                            });
                        }
                        
                        if ((!w.left || w.left.color === BLACK) && 
                            (!w.right || w.right.color === BLACK)) {
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `ÊÉÖÂÜµ2ÔºöÂÖÑÂºüËäÇÁÇπ${w.val}ÁöÑ‰∏§‰∏™Â≠êËäÇÁÇπÈÉΩÊòØÈªëËâ≤`,
                                detail: `Â∞ÜÂÖÑÂºü${w.val}ÂèòÁ∫¢ÔºåÁÑ∂ÂêéÁªßÁª≠Âêë‰∏äË∞ÉÊï¥Áà∂ËäÇÁÇπ„ÄÇ`,
                                highlightNodes: [w.val]
                            });
                            
                            w.color = RED;
                            x = xParent;
                            xParent = x.parent;
                            
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `ÂèòËâ≤ÂÆåÊàêÔºåÂêë‰∏äË∞ÉÊï¥`,
                                detail: `ÂÖÑÂºüËäÇÁÇπ${w.val}Â∑≤ÂèòÁ∫¢ÔºåÁªßÁª≠Ê£ÄÊü•Áà∂ËäÇÁÇπ„ÄÇ`,
                                highlightNodes: [x ? x.val : -1]
                            });
                        } else {
                            if (!w.right || w.right.color === BLACK) {
                                animationSteps.push({
                                    tree: this.cloneTree(),
                                    description: `ÊÉÖÂÜµ3ÔºöÂÖÑÂºüËäÇÁÇπ${w.val}ÁöÑÂè≥Â≠©Â≠êÊòØÈªëËâ≤ÔºåÂ∑¶Â≠©Â≠êÊòØÁ∫¢Ëâ≤`,
                                    detail: `Â∞ÜÂÖÑÂºüÁöÑÂ∑¶Â≠©Â≠ê${w.left.val}ÂèòÈªëÔºåÂÖÑÂºü${w.val}ÂèòÁ∫¢ÔºåÁÑ∂ÂêéÂØπÂÖÑÂºüÂè≥ÊóãÔºåËΩ¨Êç¢‰∏∫ÊÉÖÂÜµ4„ÄÇ`,
                                    highlightNodes: [w.val, w.left.val]
                                });
                                
                                if (w.left) w.left.color = BLACK;
                                w.color = RED;
                                this.rotateRight(w);
                                w = xParent.right;
                                
                                animationSteps.push({
                                    tree: this.cloneTree(),
                                    description: `Âè≥ÊóãÂÆåÊàêÔºåËΩ¨Êç¢‰∏∫ÊÉÖÂÜµ4`,
                                    detail: `Áé∞Âú®ÂÖÑÂºüÁöÑÂè≥Â≠©Â≠êÊòØÁ∫¢Ëâ≤ÔºåÂèØ‰ª•ËøõË°åÊúÄÂêéÁöÑË∞ÉÊï¥„ÄÇ`,
                                    highlightNodes: [w.val]
                                });
                            }
                            
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `ÊÉÖÂÜµ4ÔºöÂÖÑÂºüËäÇÁÇπ${w.val}ÁöÑÂè≥Â≠©Â≠êÊòØÁ∫¢Ëâ≤`,
                                detail: `Â∞ÜÂÖÑÂºü${w.val}ÊüìÊàêÁà∂ËäÇÁÇπ${xParent.val}ÁöÑÈ¢úËâ≤ÔºåÁà∂ËäÇÁÇπÂèòÈªëÔºåÂÖÑÂºüÁöÑÂè≥Â≠©Â≠êÂèòÈªëÔºåÁÑ∂ÂêéÂØπÁà∂ËäÇÁÇπÂ∑¶Êóã„ÄÇ`,
                                highlightNodes: [w.val, xParent.val, w.right ? w.right.val : -1]
                            });
                            
                            w.color = xParent.color;
                            xParent.color = BLACK;
                            if (w.right) w.right.color = BLACK;
                            this.rotateLeft(xParent);
                            x = this.root;
                            
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `Â∑¶ÊóãÂÆåÊàêÔºåÂà†Èô§Ë∞ÉÊï¥ÁªìÊùü`,
                                detail: `ÊâÄÊúâÁ∫¢ÈªëÊ†ëÊÄßË¥®Â∑≤ÊÅ¢Â§çÔºåÂà†Èô§Êìç‰ΩúÂÆåÊàêÔºÅ`,
                                highlightNodes: []
                            });
                        }
                    } else {
                        let w = xParent.left;
                        
                        if (w && w.color === RED) {
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `ÊÉÖÂÜµ1ÔºöÂÖÑÂºüËäÇÁÇπ${w.val}ÊòØÁ∫¢Ëâ≤`,
                                detail: `Â∞ÜÂÖÑÂºü${w.val}ÂèòÈªëÔºåÁà∂ËäÇÁÇπ${xParent.val}ÂèòÁ∫¢ÔºåÁÑ∂ÂêéÂØπÁà∂ËäÇÁÇπÂè≥ÊóãÔºåËΩ¨Êç¢‰∏∫ÂÖ∂‰ªñÊÉÖÂÜµ„ÄÇ`,
                                highlightNodes: [w.val, xParent.val]
                            });
                            
                            w.color = BLACK;
                            xParent.color = RED;
                            this.rotateRight(xParent);
                            w = xParent.left;
                            
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `ËΩ¨Êç¢ÂÆåÊàê`,
                                detail: `Áé∞Âú®ÂÖÑÂºüËäÇÁÇπÊòØÈªëËâ≤ÔºåÁªßÁª≠Â§ÑÁêÜ„ÄÇ`,
                                highlightNodes: [w.val]
                            });
                        }
                        
                        if ((!w.right || w.right.color === BLACK) && 
                            (!w.left || w.left.color === BLACK)) {
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `ÊÉÖÂÜµ2ÔºöÂÖÑÂºüËäÇÁÇπ${w.val}ÁöÑ‰∏§‰∏™Â≠êËäÇÁÇπÈÉΩÊòØÈªëËâ≤`,
                                detail: `Â∞ÜÂÖÑÂºü${w.val}ÂèòÁ∫¢ÔºåÁÑ∂ÂêéÁªßÁª≠Âêë‰∏äË∞ÉÊï¥Áà∂ËäÇÁÇπ„ÄÇ`,
                                highlightNodes: [w.val]
                            });
                            
                            w.color = RED;
                            x = xParent;
                            xParent = x.parent;
                            
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `ÂèòËâ≤ÂÆåÊàêÔºåÂêë‰∏äË∞ÉÊï¥`,
                                detail: `ÂÖÑÂºüËäÇÁÇπ${w.val}Â∑≤ÂèòÁ∫¢ÔºåÁªßÁª≠Ê£ÄÊü•Áà∂ËäÇÁÇπ„ÄÇ`,
                                highlightNodes: [x ? x.val : -1]
                            });
                        } else {
                            if (!w.left || w.left.color === BLACK) {
                                animationSteps.push({
                                    tree: this.cloneTree(),
                                    description: `ÊÉÖÂÜµ3ÔºöÂÖÑÂºüËäÇÁÇπ${w.val}ÁöÑÂ∑¶Â≠©Â≠êÊòØÈªëËâ≤ÔºåÂè≥Â≠©Â≠êÊòØÁ∫¢Ëâ≤`,
                                    detail: `Â∞ÜÂÖÑÂºüÁöÑÂè≥Â≠©Â≠ê${w.right.val}ÂèòÈªëÔºåÂÖÑÂºü${w.val}ÂèòÁ∫¢ÔºåÁÑ∂ÂêéÂØπÂÖÑÂºüÂ∑¶ÊóãÔºåËΩ¨Êç¢‰∏∫ÊÉÖÂÜµ4„ÄÇ`,
                                    highlightNodes: [w.val, w.right.val]
                                });
                                
                                if (w.right) w.right.color = BLACK;
                                w.color = RED;
                                this.rotateLeft(w);
                                w = xParent.left;
                                
                                animationSteps.push({
                                    tree: this.cloneTree(),
                                    description: `Â∑¶ÊóãÂÆåÊàêÔºåËΩ¨Êç¢‰∏∫ÊÉÖÂÜµ4`,
                                    detail: `Áé∞Âú®ÂÖÑÂºüÁöÑÂ∑¶Â≠©Â≠êÊòØÁ∫¢Ëâ≤ÔºåÂèØ‰ª•ËøõË°åÊúÄÂêéÁöÑË∞ÉÊï¥„ÄÇ`,
                                    highlightNodes: [w.val]
                                });
                            }
                            
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `ÊÉÖÂÜµ4ÔºöÂÖÑÂºüËäÇÁÇπ${w.val}ÁöÑÂ∑¶Â≠©Â≠êÊòØÁ∫¢Ëâ≤`,
                                detail: `Â∞ÜÂÖÑÂºü${w.val}ÊüìÊàêÁà∂ËäÇÁÇπ${xParent.val}ÁöÑÈ¢úËâ≤ÔºåÁà∂ËäÇÁÇπÂèòÈªëÔºåÂÖÑÂºüÁöÑÂ∑¶Â≠©Â≠êÂèòÈªëÔºåÁÑ∂ÂêéÂØπÁà∂ËäÇÁÇπÂè≥Êóã„ÄÇ`,
                                highlightNodes: [w.val, xParent.val, w.left ? w.left.val : -1]
                            });
                            
                            w.color = xParent.color;
                            xParent.color = BLACK;
                            if (w.left) w.left.color = BLACK;
                            this.rotateRight(xParent);
                            x = this.root;
                            
                            animationSteps.push({
                                tree: this.cloneTree(),
                                description: `Âè≥ÊóãÂÆåÊàêÔºåÂà†Èô§Ë∞ÉÊï¥ÁªìÊùü`,
                                detail: `ÊâÄÊúâÁ∫¢ÈªëÊ†ëÊÄßË¥®Â∑≤ÊÅ¢Â§çÔºåÂà†Èô§Êìç‰ΩúÂÆåÊàêÔºÅ`,
                                highlightNodes: []
                            });
                        }
                    }
                }
                
                if (x) {
                    x.color = BLACK;
                }
            }

            // ÊâæÂà∞ÊúÄÂ∞èËäÇÁÇπ
            minimum(node) {
                while (node.left) {
                    node = node.left;
                }
                return node;
            }

            // ÁßªÊ§çËäÇÁÇπ
            transplant(u, v) {
                if (!u.parent) {
                    this.root = v;
                } else if (u === u.parent.left) {
                    u.parent.left = v;
                } else {
                    u.parent.right = v;
                }
                if (v) {
                    v.parent = u.parent;
                }
            }

            // Êü•ÊâæËäÇÁÇπ
            findNode(val) {
                let current = this.root;
                while (current) {
                    if (val === current.val) return current;
                    if (val < current.val) current = current.left;
                    else current = current.right;
                }
                return null;
            }

            // Âà†Èô§Êìç‰Ωú
            delete(val) {
                animationSteps = [];
                
                const z = this.findNode(val);
                if (!z) {
                    animationSteps.push({
                        tree: this.cloneTree(),
                        description: `ËäÇÁÇπ ${val} ‰∏çÂ≠òÂú®`,
                        detail: `Ê†ë‰∏≠Ê≤°ÊúâÊâæÂà∞ÂÄº‰∏∫ ${val} ÁöÑËäÇÁÇπÔºåÊó†Ê≥ïÂà†Èô§„ÄÇ`,
                        highlightNodes: []
                    });
                    return false;
                }

                animationSteps.push({
                    tree: this.cloneTree(),
                    description: `ÂºÄÂßãÂà†Èô§ËäÇÁÇπ ${val}`,
                    detail: `ÊâæÂà∞Ë¶ÅÂà†Èô§ÁöÑËäÇÁÇπ${val}ÔºåÂáÜÂ§áËøõË°åÂà†Èô§Êìç‰Ωú„ÄÇ`,
                    highlightNodes: [val]
                });

                let y = z;
                let yOriginalColor = y.color;
                let x, xParent;

                if (!z.left) {
                    animationSteps.push({
                        tree: this.cloneTree(),
                        description: `ËäÇÁÇπ ${val} Ê≤°ÊúâÂ∑¶Â≠êÊ†ë`,
                        detail: `Áõ¥Êé•Áî®Âè≥Â≠êÊ†ëÊõøÊç¢ËäÇÁÇπ${val}„ÄÇ${yOriginalColor === BLACK ? '‚ö†Ô∏è Âà†Èô§ÁöÑÊòØÈªëËâ≤ËäÇÁÇπÔºåÂèØËÉΩÁ†¥ÂùèÈªëÈ´òÂπ≥Ë°°ÔºåÈúÄË¶ÅË∞ÉÊï¥„ÄÇ' : '‚úì Âà†Èô§ÁöÑÊòØÁ∫¢Ëâ≤ËäÇÁÇπÔºå‰∏çÂΩ±ÂìçÈªëÈ´ò„ÄÇ'}`,
                        highlightNodes: [val, z.right ? z.right.val : -1]
                    });
                    
                    x = z.right;
                    xParent = z.parent;
                    this.transplant(z, z.right);
                    
                    animationSteps.push({
                        tree: this.cloneTree(),
                        description: `ÊõøÊç¢ÂÆåÊàê`,
                        detail: `ËäÇÁÇπ${val}Â∑≤Ë¢´ÂÖ∂Âè≥Â≠êÊ†ëÊõøÊç¢„ÄÇ${yOriginalColor === BLACK ? 'ÈúÄË¶ÅËøõË°åÂà†Èô§‰øÆÂ§ç„ÄÇ' : 'Âà†Èô§ÂÆåÊàê„ÄÇ'}`,
                        highlightNodes: [x ? x.val : -1]
                    });
                } else if (!z.right) {
                    animationSteps.push({
                        tree: this.cloneTree(),
                        description: `ËäÇÁÇπ ${val} Ê≤°ÊúâÂè≥Â≠êÊ†ë`,
                        detail: `Áõ¥Êé•Áî®Â∑¶Â≠êÊ†ëÊõøÊç¢ËäÇÁÇπ${val}„ÄÇ${yOriginalColor === BLACK ? '‚ö†Ô∏è Âà†Èô§ÁöÑÊòØÈªëËâ≤ËäÇÁÇπÔºåÂèØËÉΩÁ†¥ÂùèÈªëÈ´òÂπ≥Ë°°ÔºåÈúÄË¶ÅË∞ÉÊï¥„ÄÇ' : '‚úì Âà†Èô§ÁöÑÊòØÁ∫¢Ëâ≤ËäÇÁÇπÔºå‰∏çÂΩ±ÂìçÈªëÈ´ò„ÄÇ'}`,
                        highlightNodes: [val, z.left.val]
                    });
                    
                    x = z.left;
                    xParent = z.parent;
                    this.transplant(z, z.left);
                    
                    animationSteps.push({
                        tree: this.cloneTree(),
                        description: `ÊõøÊç¢ÂÆåÊàê`,
                        detail: `ËäÇÁÇπ${val}Â∑≤Ë¢´ÂÖ∂Â∑¶Â≠êÊ†ëÊõøÊç¢„ÄÇ${yOriginalColor === BLACK ? 'ÈúÄË¶ÅËøõË°åÂà†Èô§‰øÆÂ§ç„ÄÇ' : 'Âà†Èô§ÂÆåÊàê„ÄÇ'}`,
                        highlightNodes: [x.val]
                    });
                } else {
                    y = this.minimum(z.right);
                    yOriginalColor = y.color;
                    x = y.right;
                    
                    animationSteps.push({
                        tree: this.cloneTree(),
                        description: `ËäÇÁÇπ ${val} Êúâ‰∏§‰∏™Â≠êÊ†ë`,
                        detail: `ÊâæÂà∞ÂêéÁªßËäÇÁÇπ${y.val}ÔºàÂè≥Â≠êÊ†ë‰∏≠ÁöÑÊúÄÂ∞èËäÇÁÇπÔºâÊù•ÊõøÊç¢${val}„ÄÇ`,
                        highlightNodes: [val, y.val]
                    });

                    if (y.parent === z) {
                        xParent = y;
                    } else {
                        xParent = y.parent;
                        this.transplant(y, y.right);
                        y.right = z.right;
                        y.right.parent = y;
                        
                        animationSteps.push({
                            tree: this.cloneTree(),
                            description: `ÁßªÂä®ÂêéÁªßËäÇÁÇπ ${y.val}`,
                            detail: `Â∞ÜÂêéÁªßËäÇÁÇπ${y.val}‰ªéÂéü‰ΩçÁΩÆÁßªÂá∫„ÄÇ`,
                            highlightNodes: [y.val]
                        });
                    }

                    this.transplant(z, y);
                    y.left = z.left;
                    y.left.parent = y;
                    y.color = z.color;
                    
                    animationSteps.push({
                        tree: this.cloneTree(),
                        description: `Áî®ÂêéÁªßËäÇÁÇπ ${y.val} ÊõøÊç¢ ${val}`,
                        detail: `ÂêéÁªßËäÇÁÇπ${y.val}ÁªßÊâø‰∫ÜË¢´Âà†Èô§ËäÇÁÇπ${val}ÁöÑÈ¢úËâ≤${z.color === RED ? '(Á∫¢Ëâ≤)' : '(ÈªëËâ≤)'}„ÄÇ${yOriginalColor === BLACK ? '‚ö†Ô∏è ÂéüÂêéÁªß‰ΩçÁΩÆÊòØÈªëËâ≤ÔºåÈúÄË¶ÅË∞ÉÊï¥„ÄÇ' : '‚úì ÂéüÂêéÁªß‰ΩçÁΩÆÊòØÁ∫¢Ëâ≤Ôºå‰∏çÂΩ±ÂìçÈªëÈ´ò„ÄÇ'}`,
                        highlightNodes: [y.val]
                    });
                }

                if (yOriginalColor === BLACK) {
                    this.deleteFix(x, xParent);
                }

                animationSteps.push({
                    tree: this.cloneTree(),
                    description: `Âà†Èô§ÂÆåÊàê`,
                    detail: `ËäÇÁÇπ${val}Â∑≤ÊàêÂäüÂà†Èô§ÔºåÊâÄÊúâÁ∫¢ÈªëÊ†ëÊÄßË¥®Â∑≤ÊÅ¢Â§çÔºÅ`,
                    highlightNodes: []
                });

                return true;
            }

            // ÊèíÂÖ•Êìç‰Ωú
            insert(val) {
                animationSteps = [];
                const z = new Node(val);
                let y = null;
                let x = this.root;

                animationSteps.push({
                    tree: this.cloneTree(),
                    description: `ÂºÄÂßãÊèíÂÖ•ËäÇÁÇπ ${val}`,
                    detail: `ÊåâÁÖß‰∫åÂèâÊêúÁ¥¢Ê†ëÁöÑËßÑÂàôÊü•ÊâæÊèíÂÖ•‰ΩçÁΩÆ„ÄÇÊñ∞ËäÇÁÇπÂàùÂßãÈ¢úËâ≤‰∏∫Á∫¢Ëâ≤ÔºàÈÄâÊã©Á∫¢Ëâ≤ÊòØÂõ†‰∏∫ËøôÊ†∑ËøùÂèçÁöÑÊÄßË¥®Êõ¥Â∞ëÔºåÊõ¥ÂÆπÊòì‰øÆÂ§çÔºâ„ÄÇ`,
                    highlightNodes: []
                });

                while (x) {
                    y = x;
                    if (z.val < x.val) x = x.left;
                    else x = x.right;
                }

                z.parent = y;
                if (!y) {
                    this.root = z;
                    animationSteps.push({
                        tree: this.cloneTree(),
                        description: `ÊèíÂÖ•Ê†πËäÇÁÇπ ${val}`,
                        detail: `Ê†ë‰∏∫Á©∫ÔºåËäÇÁÇπ${val}Êàê‰∏∫Ê†πËäÇÁÇπ„ÄÇÊñ∞ËäÇÁÇπÈªòËÆ§ÊòØÁ∫¢Ëâ≤„ÄÇ`,
                        highlightNodes: [val]
                    });
                } else {
                    if (z.val < y.val) y.left = z;
                    else y.right = z;
                    
                    animationSteps.push({
                        tree: this.cloneTree(),
                        description: `Â∞ÜÁ∫¢Ëâ≤ËäÇÁÇπ ${val} ÊèíÂÖ•Âà∞ËäÇÁÇπ ${y.val} ÁöÑ${z.val < y.val ? 'Â∑¶' : 'Âè≥'}Ëæπ`,
                        detail: `ÊâæÂà∞ÊèíÂÖ•‰ΩçÁΩÆÔºå‰Ωú‰∏∫ËäÇÁÇπ${y.val}ÁöÑ${z.val < y.val ? 'Â∑¶' : 'Âè≥'}Â≠©Â≠ê„ÄÇÊñ∞ÊèíÂÖ•ÁöÑËäÇÁÇπÊòØÁ∫¢Ëâ≤„ÄÇ${y.color === RED ? '‚ö†Ô∏è Áà∂ËäÇÁÇπ‰πüÊòØÁ∫¢Ëâ≤ÔºåËøùÂèç‰∫ÜÊÄßË¥®4ÔºåÈúÄË¶ÅË∞ÉÊï¥ÔºÅ' : '‚úì Áà∂ËäÇÁÇπÊòØÈªëËâ≤ÔºåÊöÇÊó∂Á¨¶ÂêàÊÄßË¥®„ÄÇ'}`,
                        highlightNodes: [val, y.val]
                    });
                }

                this.insertFix(z);
            }

            getHeight(node) {
                if (!node) return 0;
                return 1 + Math.max(this.getHeight(node.left), this.getHeight(node.right));
            }

            getBlackHeight(node) {
                if (!node) return 1;
                const leftHeight = this.getBlackHeight(node.left);
                return leftHeight + (node.color === BLACK ? 1 : 0);
            }

            getNodeCount(node) {
                if (!node) return 0;
                return 1 + this.getNodeCount(node.left) + this.getNodeCount(node.right);
            }
        }

        // ÂèØËßÜÂåñÁõ∏ÂÖ≥
        const canvas = document.getElementById('treeCanvas');
        const ctx = canvas.getContext('2d');
        let tree = new RBTree();

        const NODE_RADIUS = 25;
        const LEVEL_HEIGHT = 100;

        // ÈÄüÂ∫¶ÊéßÂà∂
        document.getElementById('speedSlider').addEventListener('input', (e) => {
            animationSpeed = parseInt(e.target.value);
            document.getElementById('speedLabel').textContent = (animationSpeed / 1000).toFixed(1) + 's';
        });

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = Math.max(container.clientWidth - 80, 800);
            canvas.height = Math.max(600, tree.getHeight(tree.root) * LEVEL_HEIGHT + 100);
            drawTree(tree);
        }

        function calculateNodePositions(node, depth, leftBound, rightBound, positions) {
            if (!node) return;

            const x = (leftBound + rightBound) / 2;
            const y = depth * LEVEL_HEIGHT + 80;
            positions.set(node, { x, y });

            const mid = (leftBound + rightBound) / 2;
            calculateNodePositions(node.left, depth + 1, leftBound, mid, positions);
            calculateNodePositions(node.right, depth + 1, mid, rightBound, positions);
        }

        function drawTree(treeObj, highlightNodes = []) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!treeObj.root) return;

            const positions = new Map();
            calculateNodePositions(treeObj.root, 0, 0, canvas.width, positions);

            // ÁªòÂà∂Ëæπ
            function drawEdges(node) {
                if (!node) return;
                const pos = positions.get(node);

                if (node.left) {
                    const leftPos = positions.get(node.left);
                    ctx.beginPath();
                    ctx.moveTo(pos.x, pos.y);
                    ctx.lineTo(leftPos.x, leftPos.y);
                    ctx.strokeStyle = '#95a5a6';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    drawEdges(node.left);
                }

                if (node.right) {
                    const rightPos = positions.get(node.right);
                    ctx.beginPath();
                    ctx.moveTo(pos.x, pos.y);
                    ctx.lineTo(rightPos.x, rightPos.y);
                    ctx.strokeStyle = '#95a5a6';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    drawEdges(node.right);
                }
            }

            drawEdges(treeObj.root);

            // ÁªòÂà∂ËäÇÁÇπ
            function drawNodes(node) {
                if (!node) return;
                const pos = positions.get(node);
                const isHighlight = highlightNodes.includes(node.val);

                ctx.beginPath();
                ctx.arc(pos.x, pos.y, NODE_RADIUS, 0, 2 * Math.PI);
                ctx.fillStyle = node.color === RED ? '#ff4757' : '#2f3542';
                ctx.fill();
                
                // Á∫¢Ëâ≤ËäÇÁÇπÁî®Á∫¢Ëâ≤ËæπÊ°ÜÔºåÈªëËâ≤ËäÇÁÇπÁî®ÈªëËâ≤ËæπÊ°Ü
                ctx.strokeStyle = node.color === RED ? '#ff1744' : '#000';
                ctx.lineWidth = isHighlight ? 5 : 3;
                ctx.stroke();

                // È´ò‰∫ÆÊïàÊûú
                if (isHighlight) {
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, NODE_RADIUS + 8, 0, 2 * Math.PI);
                    ctx.strokeStyle = '#ffd700';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }

                ctx.fillStyle = 'white';
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(node.val, pos.x, pos.y);

                drawNodes(node.left);
                drawNodes(node.right);
            }

            drawNodes(treeObj.root);
            updateStats(treeObj);
        }

        function updateStats(treeObj) {
            const nodeCount = treeObj.getNodeCount(treeObj.root);
            const height = treeObj.getHeight(treeObj.root);
            const blackHeight = treeObj.getBlackHeight(treeObj.root);
            document.getElementById('treeStats').innerHTML = 
                `ËäÇÁÇπÊï∞: ${nodeCount}<br>Ê†ëÈ´ò: ${height}<br>ÈªëÈ´ò: ${blackHeight}`;
        }

        function displaySteps() {
            const stepsContent = document.getElementById('stepsContent');
            stepsContent.innerHTML = '';

            animationSteps.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step-item';
                stepDiv.id = `step-${index}`;
                
                stepDiv.innerHTML = `
                    <div>
                        <span class="step-number">${index + 1}</span>
                        <span class="step-title">${step.description}</span>
                    </div>
                    <div class="step-description">${step.detail}</div>
                `;
                
                stepsContent.appendChild(stepDiv);
            });
        }

        async function animateSteps() {
            isAnimating = true;
            disableControls();

            for (let i = 0; i < animationSteps.length; i++) {
                const step = animationSteps[i];
                const stepDiv = document.getElementById(`step-${i}`);
                
                // È´ò‰∫ÆÂΩìÂâçÊ≠•È™§
                document.querySelectorAll('.step-item').forEach(el => {
                    el.classList.remove('current', 'highlight');
                });
                stepDiv.classList.add('current', 'highlight');
                stepDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // ÁªòÂà∂ÂΩìÂâçÁä∂ÊÄÅÁöÑÊ†ë
                const currentTree = step.tree;
                canvas.height = Math.max(600, currentTree.getHeight(currentTree.root) * LEVEL_HEIGHT + 100);
                drawTree(currentTree, step.highlightNodes);

                await sleep(animationSpeed);
            }

            // ÊúÄÁªàÁä∂ÊÄÅ
            tree = animationSteps[animationSteps.length - 1].tree;
            resizeCanvas();

            isAnimating = false;
            enableControls();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function disableControls() {
            document.getElementById('insertBtn').disabled = true;
            document.getElementById('deleteBtn').disabled = true;
            document.getElementById('clearBtn').disabled = true;
            document.getElementById('randomBtn').disabled = true;
            document.querySelectorAll('.preset-btn').forEach(btn => btn.disabled = true);
        }

        function enableControls() {
            document.getElementById('insertBtn').disabled = false;
            document.getElementById('deleteBtn').disabled = false;
            document.getElementById('clearBtn').disabled = false;
            document.getElementById('randomBtn').disabled = false;
            document.querySelectorAll('.preset-btn').forEach(btn => btn.disabled = false);
        }

        function showMessage(text, type = 'success') {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 2000);
        }

        async function insertValue() {
            if (isAnimating) return;

            const input = document.getElementById('valueInput');
            const val = parseInt(input.value);

            if (isNaN(val) || val < 1 || val > 999) {
                showMessage('ËØ∑ËæìÂÖ•1-999‰πãÈó¥ÁöÑÊï∞ÂÄº', 'error');
                return;
            }

            tree.insert(val);
            displaySteps();
            input.value = '';
            
            await animateSteps();
            showMessage(`ÊàêÂäüÊèíÂÖ•ËäÇÁÇπ ${val}`);
        }

        async function deleteValue() {
            if (isAnimating) return;

            const input = document.getElementById('valueInput');
            const val = parseInt(input.value);

            if (isNaN(val) || val < 1 || val > 999) {
                showMessage('ËØ∑ËæìÂÖ•1-999‰πãÈó¥ÁöÑÊï∞ÂÄº', 'error');
                return;
            }

            const success = tree.delete(val);
            displaySteps();
            input.value = '';
            
            await animateSteps();
            
            if (success) {
                showMessage(`ÊàêÂäüÂà†Èô§ËäÇÁÇπ ${val}`);
            } else {
                showMessage(`ËäÇÁÇπ ${val} ‰∏çÂ≠òÂú®`, 'error');
            }
        }

        function clearTree() {
            if (isAnimating) return;
            tree = new RBTree();
            animationSteps = [];
            resizeCanvas();
            document.getElementById('stepsContent').innerHTML = `
                <div style="text-align: center; color: #6c757d; padding: 40px 20px;">
                    <p style="font-size: 1.2em; margin-bottom: 15px;">üëã Ê¨¢Ëøé‰ΩøÁî®Á∫¢ÈªëÊ†ëÂèØËßÜÂåñÂ∑•ÂÖ∑</p>
                    <p>üëà ËæìÂÖ•Êï∞ÂÄºÔºåÂèØ‰ª•ÊèíÂÖ•ÊàñÂà†Èô§ËäÇÁÇπ</p>
                    <p style="margin-top: 10px;">Êàñ‰ΩøÁî®È¢ÑËÆæÁ§∫‰æãÂø´ÈÄüÂºÄÂßã</p>
                    <p style="margin-top: 10px;">ËøôÈáå‰ºöÊòæÁ§∫ÊØè‰∏ÄÊ≠•ÁöÑËØ¶ÁªÜÊìç‰ΩúËØ¥Êòé</p>
                </div>
            `;
            showMessage('Ê†ëÂ∑≤Ê∏ÖÁ©∫');
        }

        async function randomTree() {
            if (isAnimating) return;
            
            tree = new RBTree();
            const count = 5 + Math.floor(Math.random() * 5);
            const values = new Set();
            
            while (values.size < count) {
                values.add(Math.floor(Math.random() * 100) + 1);
            }

            showMessage(`ÂºÄÂßãÁîüÊàêÂåÖÂê´ ${count} ‰∏™ËäÇÁÇπÁöÑÈöèÊú∫Ê†ë`);
            
            for (const v of values) {
                tree.insert(v);
                displaySteps();
                await animateSteps();
                await sleep(500);
            }
            
            showMessage(`ÊàêÂäüÁîüÊàêÂåÖÂê´ ${count} ‰∏™ËäÇÁÇπÁöÑÈöèÊú∫Ê†ë`);
        }

        async function loadPreset(values) {
            if (isAnimating) return;
            
            tree = new RBTree();
            showMessage(`ÂºÄÂßãÂä†ËΩΩÈ¢ÑËÆæ: [${values.join(', ')}]`);
            
            for (const v of values) {
                tree.insert(v);
                displaySteps();
                await animateSteps();
                await sleep(500);
            }
            
            showMessage(`È¢ÑËÆæÂä†ËΩΩÂÆåÊàê`);
        }

        // ÈîÆÁõò‰∫ã‰ª∂
        document.getElementById('valueInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isAnimating) insertValue();
        });

        // ÂàùÂßãÂåñ
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
    </script>
</body>
</html>