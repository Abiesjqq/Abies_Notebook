CPU 由 control unit 和 datapath 组成，其中 datapath 包含多路选择器、ALU、寄存器等。

CPU 的性能由什么决定？指令数目（由指令集和编译器决定）、CPI（和硬件相关）、时钟周期 Cycle time。  
两种实现：单周期、流水线

执行指令：将指令从指令存储器中取出来 -> 指令解码，读寄存器（解码 opcode 的同时读寄存器） -> 根据指令不同，读内存或计算或跳转等。  
ALU 要做的：算术逻辑运算、内存读写、分支比较

![4-1](../resources/4-1.png)

ALU 的输入可能来自指令（立即数），可能来自寄存器。  
当输入或输出有多种可能时，用多路选择器实现。MUX 是选择位由指令类型（可能还有比较结果）决定。

![4-2](../resources/4-2.png)

寄存器（D 触发器）：时钟上升沿时将输入 D 的值放到输出 Q。  
增加写使能 Write，只有 Write 为 1、时钟上升沿才将 Q 变为 D。  
组合逻辑的长度决定时钟的周期。

指令的实现分为几步：取指令 -> 解码、读操作数 -> 控制执行 -> 访问内存 -> 把结果写回寄存器 -> 把 PC 值改为下一条的值。

不同指令要做的事？  
R 型：寄存器、ALU。从寄存器中读数据，输出两个值到 ALU，ALU 计算后写回到寄存器。  
Load/Store 指令：内存、立即数单元（指令中取出的 32 位立即数扩展为 64 位）。  
B 型：用 ALU 比较，看结果是不是零。立即数要左移一位。

示例：R 型指令中，指令 rs2, rs1, rd 解码后，将寄存器中的值输给 ALU。func7, func3 用于控制 ALU 执行哪种操作。opcode 作为控制单元，作为寄存器的写使能，同时和 func 一起控制 ALU。  
I 型指令中，rs1, rd 作为寄存器的读，imm 经过扩展后，和寄存器读出的值一起输入到 ALU，func3, imm, opcode 一起控制 ALU 操作。ALU 输出结果作为 data memory 的地址，从内存中读数据后写回到寄存器。  
（略）

![4-datapath](../resources/4-datapath.png)

共 7+4 个控制信号。

ALU 的控制信号怎么产生？  
Load/Store 一定是加法  
Branch 指令一定是减法  
R 型指令：两级解码。第一级解码，只用 opcode，将除了 ALU control 外的所有控制信号；第二级解码，用 func7、func3 和第一季解码得到的类型，决定 ALU 操作。  
在 opcode 中将指令分为四类：ld 00，sd 00，Beq 01，R 10，第一级解码后得到类别。
