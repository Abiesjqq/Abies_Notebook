
## 潜在结果与因果效应公式

设：  
- $T_i \in \{0,1\}$ 表示个体 $i$ 是否接受处理（treatment），1=处理，0=对照  
- $Y_i(1)$ 表示个体 $i$ 在 $T_i=1$ 时的结果（处理后的潜在结果）  
- $Y_i(0)$ 表示个体 $i$ 在 $T_i=0$ 时的结果（未处理的潜在结果）  

**个体因果效应（Individual Treatment Effect, ITE）：**

$$
\tau_i = Y_i(1) - Y_i(0)
$$

**平均处理效应（Average Treatment Effect, ATE）：**

$$
\text{ATE} = E[Y(1) - Y(0)]
$$

其他常用效应：  

- **ATT**（Average Treatment effect on the Treated）：

$$
\text{ATT} = E[Y(1) - Y(0) \mid T=1]
$$

- **ATC**（Average Treatment effect on the Controls）：

$$
\text{ATC} = E[Y(1) - Y(0) \mid T=0]
$$

---

## 核心识别假设（Identification Assumptions）

**SUTVA（稳定单元处理值假设）**  
   数学表达：

$$
Y_i(t) \ \text{与其他个体的处理状态无关，且处理定义唯一}
$$

   对所有 $t \in \{0,1\}$。

**可忽略性 / 无混淆（Unconfoundedness）**  
   给定协变量 $X$：

$$
(Y(1), Y(0)) \perp\!\!\!\perp T \mid X
$$

   意味着处理分配与潜在结果在控制了 $X$ 后相互独立。

**重叠性（Overlap / Positivity）**  
   对所有 $X$：

$$
0 < P(T=1 \mid X) < 1
$$

   处理组和对照组都有可能存在于每个协变量水平下。

---

## 不同估计方法的公式

### 随机对照试验（RCT）
因为随机化 $\Rightarrow (Y(1), Y(0)) \perp\!\!\!\perp T$  
ATE 估计：

$$
\hat{\tau}_{\text{RCT}} = \bar{Y}_{T=1} - \bar{Y}_{T=0}
$$

---

### 回归调整（Regression Adjustment）
拟合：

$$
E[Y \mid T, X] = \alpha + \tau T + f(X)
$$

估计：

$$
\hat{\tau} = \frac{1}{n} \sum_{i=1}^n \big[ \hat{E}(Y \mid T=1, X_i) - \hat{E}(Y \mid T=0, X_i) \big]
$$

---

### 匹配（Matching）
对每个处理组个体 $i$，找到一个或多个相似协变量 $X$ 的对照组个体 $j$：

$$
\hat{\tau}_{\text{match}} = \frac{1}{n_T} \sum_{i: T_i=1} \left[ Y_i - \frac{1}{|M(i)|} \sum_{j \in M(i)} Y_j \right]
$$

其中 $M(i)$ 是匹配集合。

---

### 倾向得分加权（IPW / IPTW）
倾向得分：

$$
e(X) = P(T=1 \mid X)
$$

ATE 估计：

$$
\hat{\tau}_{\text{IPW}} = \frac{1}{n} \sum_{i=1}^n \left( \frac{T_i Y_i}{\hat{e}(X_i)} - \frac{(1-T_i) Y_i}{1 - \hat{e}(X_i)} \right)
$$

---

### 工具变量（IV）
若存在 $Z$ 满足：  
1. $Z \not\!\perp\!\!\!\perp T$（相关性）    
2. $Z \perp\!\!\!\perp (Y(1), Y(0)) \mid X$（外生性）    

线性模型下：

$$
\tau_{\text{IV}} = \frac{\text{Cov}(Y, Z)}{\text{Cov}(T, Z)}
$$

---

### 双重稳健（Doubly Robust）
结合回归调整与IPW：

$$
\hat{\tau}_{\text{DR}} = \frac{1}{n} \sum_{i=1}^n \left[ \frac{T_i (Y_i - \hat{m}_1(X_i))}{\hat{e}(X_i)} - \frac{(1-T_i) (Y_i - \hat{m}_0(X_i))}{1 - \hat{e}(X_i)} + \hat{m}_1(X_i) - \hat{m}_0(X_i) \right]
$$

其中 $\hat{m}_t(X) = \hat{E}[Y \mid T=t, X]$。

---

## 总结公式化的因果推断思路  
1. **定义潜在结果**：$Y(1), Y(0)$  
2. **定义目标效应**：ATE / ATT / ATC  
3. **假设条件**：SUTVA + 可忽略性 + 重叠性  
4. **选择估计公式**：根据数据类型（RCT / 观测数据）和假设选择对应方法公式
