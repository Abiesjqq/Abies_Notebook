
## R 语言基础

先写一个表达式辅助函数


``` r
print_expr <- function(expr) {
  e <- substitute(expr) # 捕获原始表达式
  v <- eval(e, envir = parent.frame()) # 计算

  # 确保表达式显示为一行
  expr_str <- paste(deparse(e), collapse = " ")

  cat(expr_str, "= ")

  if (is.atomic(v) && length(v) > 1) {
    cat(v, sep = " ")
    cat("\n")
  } else if (is.matrix(v) || is.data.frame(v)) {
    print(v)
  } else {
    print(v)
  }

  invisible(v)
}
```

### 基本向量


``` r
# R 的向量，用 c() 创建
x <- c(1, 2, 3, 4)
```


``` r
print_expr(x[1]) # R 取第1个，下标从 1 开始
```

```
## x[1] = [1] 1
```

``` r
print_expr(x + 1)
```

```
## x + 1 = 2 3 4 5
```

``` r
print_expr(x)
```

```
## x = 1 2 3 4
```

## 数据 Dataframe


``` r
df <- data.frame(
  id = 1:8,
  name = c("Alice", "Bob", "Carol", "David", "Eve", "Frank", "Grace", "Heidi"),
  dept = c("HR", "IT", "Finance", "HR", "Finance", "IT", "Finance", "HR"),
  age = c(25, 30, 27, 22, 29, 35, 28, 26),
  score = c(80, 95, 67, 88, 90, 72, 85, 60),
  feat_a = c(1.2, 3.4, 2.5, 0.9, 4.1, 3.3, 2.9, 1.5),
  feat_b = c(5, 6, 7, 5, 8, 7, 6, 5),
  warn_flag = c(TRUE, FALSE, TRUE, FALSE, FALSE, TRUE, FALSE, TRUE)
)
df
```

```
##   id  name    dept age score feat_a feat_b warn_flag
## 1  1 Alice      HR  25    80    1.2      5      TRUE
## 2  2   Bob      IT  30    95    3.4      6     FALSE
## 3  3 Carol Finance  27    67    2.5      7      TRUE
## 4  4 David      HR  22    88    0.9      5     FALSE
## 5  5   Eve Finance  29    90    4.1      8     FALSE
## 6  6 Frank      IT  35    72    3.3      7      TRUE
## 7  7 Grace Finance  28    85    2.9      6     FALSE
## 8  8 Heidi      HR  26    60    1.5      5      TRUE
```

### 访问列

返回列向量 `c()`


``` r
df$a # 用 $ 访问列
```

```
## [1] 25 30 27 22 29 35 28 26
```

``` r
df[["a"]] # 类似 Python 的 df["age"]
```

```
## NULL
```

``` r
df[, "a"] # 按列名取
```

```
## Error in `[.data.frame`(df, , "a"): 选择了未定义的列
```

### 访问行

返回 Dataframe


``` r
df[1, ] # 第一行
```

```
##   id  name dept age score feat_a feat_b warn_flag
## 1  1 Alice   HR  25    80    1.2      5      TRUE
```

``` r
df[2, ] # 第二行
```

```
##   id name dept age score feat_a feat_b warn_flag
## 2  2  Bob   IT  30    95    3.4      6     FALSE
```

### 条件筛选


``` r
df[df$b > 2, ] # b > 2 的行
```

```
## [1] id        name      dept      age       score     feat_a    feat_b    warn_flag
## <0 行> (或0-长度的row.names)
```

``` r
df[df$a == "a", ]
```

```
## [1] id        name      dept      age       score     feat_a    feat_b    warn_flag
## <0 行> (或0-长度的row.names)
```

## dplyr

%\>% 叫做 **管道操作符**（pipe operator），就像把一条数据分析流水线写出来，类似于 Python 里链式调用 `df.query().groupby().mean()`

### 核心动词

-   `filter`: 按行筛选

    
    ``` r
    df %>% filter(age > 25, score >= 80)      # 与条件默认AND
    ```
    
    ```
    ##   id  name    dept age score feat_a feat_b warn_flag
    ## 1  2   Bob      IT  30    95    3.4      6     FALSE
    ## 2  5   Eve Finance  29    90    4.1      8     FALSE
    ## 3  7 Grace Finance  28    85    2.9      6     FALSE
    ```
    
    ``` r
    df %>% filter(age > 25 | score >= 80)     # OR
    ```
    
    ```
    ##   id  name    dept age score feat_a feat_b warn_flag
    ## 1  1 Alice      HR  25    80    1.2      5      TRUE
    ## 2  2   Bob      IT  30    95    3.4      6     FALSE
    ## 3  3 Carol Finance  27    67    2.5      7      TRUE
    ## 4  4 David      HR  22    88    0.9      5     FALSE
    ## 5  5   Eve Finance  29    90    4.1      8     FALSE
    ## 6  6 Frank      IT  35    72    3.3      7      TRUE
    ## 7  7 Grace Finance  28    85    2.9      6     FALSE
    ## 8  8 Heidi      HR  26    60    1.5      5      TRUE
    ```
    
    ``` r
    df %>% filter(!is.na(score))              # 处理缺失
    ```
    
    ```
    ##   id  name    dept age score feat_a feat_b warn_flag
    ## 1  1 Alice      HR  25    80    1.2      5      TRUE
    ## 2  2   Bob      IT  30    95    3.4      6     FALSE
    ## 3  3 Carol Finance  27    67    2.5      7      TRUE
    ## 4  4 David      HR  22    88    0.9      5     FALSE
    ## 5  5   Eve Finance  29    90    4.1      8     FALSE
    ## 6  6 Frank      IT  35    72    3.3      7      TRUE
    ## 7  7 Grace Finance  28    85    2.9      6     FALSE
    ## 8  8 Heidi      HR  26    60    1.5      5      TRUE
    ```

-   `select` / `rename` / `relocate` : 选列、重命名、挪列

    
    ``` r
    df %>% select(name, age, score)
    ```
    
    ```
    ##    name age score
    ## 1 Alice  25    80
    ## 2   Bob  30    95
    ## 3 Carol  27    67
    ## 4 David  22    88
    ## 5   Eve  29    90
    ## 6 Frank  35    72
    ## 7 Grace  28    85
    ## 8 Heidi  26    60
    ```
    
    ``` r
    df %>% select(-name, starts_with("feat_"))     # tidyselect 语法
    ```
    
    ```
    ##   id    dept age score feat_a feat_b warn_flag
    ## 1  1      HR  25    80    1.2      5      TRUE
    ## 2  2      IT  30    95    3.4      6     FALSE
    ## 3  3 Finance  27    67    2.5      7      TRUE
    ## 4  4      HR  22    88    0.9      5     FALSE
    ## 5  5 Finance  29    90    4.1      8     FALSE
    ## 6  6      IT  35    72    3.3      7      TRUE
    ## 7  7 Finance  28    85    2.9      6     FALSE
    ## 8  8      HR  26    60    1.5      5      TRUE
    ```
    
    ``` r
    df %>% rename(avg = score)                   # rename(new = old)
    ```
    
    ```
    ##   id  name    dept age avg feat_a feat_b warn_flag
    ## 1  1 Alice      HR  25  80    1.2      5      TRUE
    ## 2  2   Bob      IT  30  95    3.4      6     FALSE
    ## 3  3 Carol Finance  27  67    2.5      7      TRUE
    ## 4  4 David      HR  22  88    0.9      5     FALSE
    ## 5  5   Eve Finance  29  90    4.1      8     FALSE
    ## 6  6 Frank      IT  35  72    3.3      7      TRUE
    ## 7  7 Grace Finance  28  85    2.9      6     FALSE
    ## 8  8 Heidi      HR  26  60    1.5      5      TRUE
    ```
    
    ``` r
    df %>% relocate(score, .after = name)        # 调整列顺序
    ```
    
    ```
    ##   id  name score    dept age feat_a feat_b warn_flag
    ## 1  1 Alice    80      HR  25    1.2      5      TRUE
    ## 2  2   Bob    95      IT  30    3.4      6     FALSE
    ## 3  3 Carol    67 Finance  27    2.5      7      TRUE
    ## 4  4 David    88      HR  22    0.9      5     FALSE
    ## 5  5   Eve    90 Finance  29    4.1      8     FALSE
    ## 6  6 Frank    72      IT  35    3.3      7      TRUE
    ## 7  7 Grace    85 Finance  28    2.9      6     FALSE
    ## 8  8 Heidi    60      HR  26    1.5      5      TRUE
    ```

-   `arrange` : 排序

    
    ``` r
    df %>% arrange(age, desc(score))
    ```
    
    ```
    ##   id  name    dept age score feat_a feat_b warn_flag
    ## 1  4 David      HR  22    88    0.9      5     FALSE
    ## 2  1 Alice      HR  25    80    1.2      5      TRUE
    ## 3  8 Heidi      HR  26    60    1.5      5      TRUE
    ## 4  3 Carol Finance  27    67    2.5      7      TRUE
    ## 5  7 Grace Finance  28    85    2.9      6     FALSE
    ## 6  5   Eve Finance  29    90    4.1      8     FALSE
    ## 7  2   Bob      IT  30    95    3.4      6     FALSE
    ## 8  6 Frank      IT  35    72    3.3      7      TRUE
    ```

-   `mutats` / `transmute` : 造列

    
    ``` r
    df %>% mutate(zscore = (score - mean(score, na.rm = TRUE)) / sd(score, na.rm = TRUE))
    ```
    
    ```
    ##   id  name    dept age score feat_a feat_b warn_flag      zscore
    ## 1  1 Alice      HR  25    80    1.2      5      TRUE  0.03067894
    ## 2  2   Bob      IT  30    95    3.4      6     FALSE  1.25783668
    ## 3  3 Carol Finance  27    67    2.5      7      TRUE -1.03285776
    ## 4  4 David      HR  22    88    0.9      5     FALSE  0.68516307
    ## 5  5   Eve Finance  29    90    4.1      8     FALSE  0.84878410
    ## 6  6 Frank      IT  35    72    3.3      7      TRUE -0.62380518
    ## 7  7 Grace Finance  28    85    2.9      6     FALSE  0.43973152
    ## 8  8 Heidi      HR  26    60    1.5      5      TRUE -1.60553137
    ```
    
    ``` r
    df %>% transmute(name, zscore = (score - mean(score, na.rm = TRUE)) / sd(score, na.rm = TRUE))  # 只保留新列
    ```
    
    ```
    ##    name      zscore
    ## 1 Alice  0.03067894
    ## 2   Bob  1.25783668
    ## 3 Carol -1.03285776
    ## 4 David  0.68516307
    ## 5   Eve  0.84878410
    ## 6 Frank -0.62380518
    ## 7 Grace  0.43973152
    ## 8 Heidi -1.60553137
    ```

-   `summarise`（统计汇总）+ `group_by`（分组）

    
    ``` r
    df %>%
      group_by(dept) %>%
      summarise(
        n = n(),
        mean_score = mean(score, na.rm = TRUE),
        n_unique_name = n_distinct(name),
        .groups = "drop"  # 汇总后去掉分组，常用
    )
    ```
    
    ```
    ## # A tibble: 3 × 4
    ##   dept        n mean_score n_unique_name
    ##   <chr>   <int>      <dbl>         <int>
    ## 1 Finance     3       80.7             3
    ## 2 HR          3       76               3
    ## 3 IT          2       83.5             2
    ```

    或者

    
    ``` r
    df %>%
      summarise(
        n = n(),
        mean_score = mean(score, na.rm = TRUE),
        .by = dept
      )
    ```
    
    ```
    ##      dept n mean_score
    ## 1      HR 3   76.00000
    ## 2      IT 2   83.50000
    ## 3 Finance 3   80.66667
    ```

### 批量操作

`across` + `tidyselect`


``` r
# 所有数值列做标准化
df %>% mutate(across(where(is.numeric),
                     ~ (.-mean(., na.rm=TRUE))/sd(., na.rm=TRUE)))
```

```
##           id  name    dept         age       score      feat_a     feat_b warn_flag
## 1 -1.4288690 Alice      HR -0.71517371  0.03067894 -1.09938306 -0.9991193      TRUE
## 2 -1.0206207   Bob      IT  0.58514212  1.25783668  0.79759164 -0.1110133     FALSE
## 3 -0.6123724 Carol Finance -0.19504737 -1.03285776  0.02155653  0.7770928      TRUE
## 4 -0.2041241 David      HR -1.49536320  0.68516307 -1.35806143 -0.9991193     FALSE
## 5  0.2041241   Eve Finance  0.32507896  0.84878410  1.40117449  1.6651989     FALSE
## 6  0.6123724 Frank      IT  1.88545795 -0.62380518  0.71136551  0.7770928      TRUE
## 7  1.0206207 Grace Finance  0.06501579  0.43973152  0.36646102 -0.1110133     FALSE
## 8  1.4288690 Heidi      HR -0.45511054 -1.60553137 -0.84070470 -0.9991193      TRUE
```

``` r
# 指定列名模式
df %>% mutate(across(starts_with("feat_"), log1p))
```

```
##   id  name    dept age score    feat_a   feat_b warn_flag
## 1  1 Alice      HR  25    80 0.7884574 1.791759      TRUE
## 2  2   Bob      IT  30    95 1.4816045 1.945910     FALSE
## 3  3 Carol Finance  27    67 1.2527630 2.079442      TRUE
## 4  4 David      HR  22    88 0.6418539 1.791759     FALSE
## 5  5   Eve Finance  29    90 1.6292405 2.197225     FALSE
## 6  6 Frank      IT  35    72 1.4586150 2.079442      TRUE
## 7  7 Grace Finance  28    85 1.3609766 1.945910     FALSE
## 8  8 Heidi      HR  26    60 0.9162907 1.791759      TRUE
```

``` r
# 多个统计量汇总并重命名
df %>%
  summarise(across(where(is.numeric),
                   list(mean = ~mean(., na.rm=TRUE),
                        sd   = ~sd(., na.rm=TRUE)),
                   .names = "{.col}_{.fn}"),
            .by = dept)
```

```
##      dept  id_mean    id_sd age_mean   age_sd score_mean score_sd feat_a_mean  feat_a_sd feat_b_mean feat_b_sd
## 1      HR 4.333333 3.511885 24.33333 2.081666   76.00000 14.42221    1.200000 0.30000000         5.0 0.0000000
## 2      IT 4.000000 2.828427 32.50000 3.535534   83.50000 16.26346    3.350000 0.07071068         6.5 0.7071068
## 3 Finance 5.000000 2.000000 28.00000 1.000000   80.66667 12.09683    3.166667 0.83266640         7.0 1.0000000
```

常用 tidyselect:

-   `starts_with("x")`, `ends_with("y")`, `contains("key")`, `matches("regex")`

-   `where(is.numeric)`, `everything()`

### 行操作与取样

`slice` / `distinct` / `count`


``` r
df %>% slice(1:5)                 # 前五行
```

```
##   id  name    dept age score feat_a feat_b warn_flag
## 1  1 Alice      HR  25    80    1.2      5      TRUE
## 2  2   Bob      IT  30    95    3.4      6     FALSE
## 3  3 Carol Finance  27    67    2.5      7      TRUE
## 4  4 David      HR  22    88    0.9      5     FALSE
## 5  5   Eve Finance  29    90    4.1      8     FALSE
```

``` r
df %>% slice_head(n = 5)          # 等价
```

```
##   id  name    dept age score feat_a feat_b warn_flag
## 1  1 Alice      HR  25    80    1.2      5      TRUE
## 2  2   Bob      IT  30    95    3.4      6     FALSE
## 3  3 Carol Finance  27    67    2.5      7      TRUE
## 4  4 David      HR  22    88    0.9      5     FALSE
## 5  5   Eve Finance  29    90    4.1      8     FALSE
```

``` r
df %>% slice_max(order_by = score, n = 3)  # 最高分前3（替代已废弃的 top_n）
```

```
##   id  name    dept age score feat_a feat_b warn_flag
## 1  2   Bob      IT  30    95    3.4      6     FALSE
## 2  5   Eve Finance  29    90    4.1      8     FALSE
## 3  4 David      HR  22    88    0.9      5     FALSE
```

``` r
df %>% distinct(name, .keep_all = TRUE)    # 去重（按 name 保留第一条）
```

```
##   id  name    dept age score feat_a feat_b warn_flag
## 1  1 Alice      HR  25    80    1.2      5      TRUE
## 2  2   Bob      IT  30    95    3.4      6     FALSE
## 3  3 Carol Finance  27    67    2.5      7      TRUE
## 4  4 David      HR  22    88    0.9      5     FALSE
## 5  5   Eve Finance  29    90    4.1      8     FALSE
## 6  6 Frank      IT  35    72    3.3      7      TRUE
## 7  7 Grace Finance  28    85    2.9      6     FALSE
## 8  8 Heidi      HR  26    60    1.5      5      TRUE
```

``` r
df %>% count(dept, sort = TRUE)            # 计数（Pandas: value_counts）
```

```
##      dept n
## 1 Finance 3
## 2      HR 3
## 3      IT 2
```

``` r
df %>% add_count(dept)                      # 在原表上添加计数列
```

```
##   id  name    dept age score feat_a feat_b warn_flag n
## 1  1 Alice      HR  25    80    1.2      5      TRUE 3
## 2  2   Bob      IT  30    95    3.4      6     FALSE 2
## 3  3 Carol Finance  27    67    2.5      7      TRUE 3
## 4  4 David      HR  22    88    0.9      5     FALSE 3
## 5  5   Eve Finance  29    90    4.1      8     FALSE 3
## 6  6 Frank      IT  35    72    3.3      7      TRUE 2
## 7  7 Grace Finance  28    85    2.9      6     FALSE 3
## 8  8 Heidi      HR  26    60    1.5      5      TRUE 3
```

``` r
df %>% slice_sample(n = 100)                # 随机抽样
```

```
##   id  name    dept age score feat_a feat_b warn_flag
## 1  8 Heidi      HR  26    60    1.5      5      TRUE
## 2  4 David      HR  22    88    0.9      5     FALSE
## 3  3 Carol Finance  27    67    2.5      7      TRUE
## 4  6 Frank      IT  35    72    3.3      7      TRUE
## 5  1 Alice      HR  25    80    1.2      5      TRUE
## 6  7 Grace Finance  28    85    2.9      6     FALSE
## 7  2   Bob      IT  30    95    3.4      6     FALSE
## 8  5   Eve Finance  29    90    4.1      8     FALSE
```

### 分组内的「窗口函数」与排名

(有点复杂)


``` r
df %>%
  arrange(dept, desc(score)) %>%
  group_by(dept) %>%
  mutate(
    rk = row_number(),          # 组内名次（严格递增）
    dr = dense_rank(desc(score)),# 组内排名（并列不跳号）
    sdiff = score - lag(score), # 与上一名差距
    next_score = lead(score)    # 下一名分数
  ) %>%
  ungroup()
```

```
## # A tibble: 8 × 12
##      id name  dept      age score feat_a feat_b warn_flag    rk    dr sdiff next_score
##   <int> <chr> <chr>   <dbl> <dbl>  <dbl>  <dbl> <lgl>     <int> <int> <dbl>      <dbl>
## 1     5 Eve   Finance    29    90    4.1      8 FALSE         1     1    NA         85
## 2     7 Grace Finance    28    85    2.9      6 FALSE         2     2    -5         67
## 3     3 Carol Finance    27    67    2.5      7 TRUE          3     3   -18         NA
## 4     4 David HR         22    88    0.9      5 FALSE         1     1    NA         80
## 5     1 Alice HR         25    80    1.2      5 TRUE          2     2    -8         60
## 6     8 Heidi HR         26    60    1.5      5 TRUE          3     3   -20         NA
## 7     2 Bob   IT         30    95    3.4      6 FALSE         1     1    NA         72
## 8     6 Frank IT         35    72    3.3      7 TRUE          2     2   -23         NA
```

### 条件与缺失值处理

`case_when` / `if_else` / `coalesce`


``` r
df %>%
  mutate(
    level = case_when(
      score >= 90 ~ "A",
      score >= 80 ~ "B",
      score >= 70 ~ "C",
      TRUE        ~ "D"
    ),
    pass = if_else(score >= 60, TRUE, FALSE, missing = NA),
    score_filled = coalesce(score, 0)   # 用0填补缺失
  )
```

```
##   id  name    dept age score feat_a feat_b warn_flag level pass score_filled
## 1  1 Alice      HR  25    80    1.2      5      TRUE     B TRUE           80
## 2  2   Bob      IT  30    95    3.4      6     FALSE     A TRUE           95
## 3  3 Carol Finance  27    67    2.5      7      TRUE     D TRUE           67
## 4  4 David      HR  22    88    0.9      5     FALSE     B TRUE           88
## 5  5   Eve Finance  29    90    4.1      8     FALSE     A TRUE           90
## 6  6 Frank      IT  35    72    3.3      7      TRUE     C TRUE           72
## 7  7 Grace Finance  28    85    2.9      6     FALSE     B TRUE           85
## 8  8 Heidi      HR  26    60    1.5      5      TRUE     D TRUE           60
```

### 连接 (`join`)

设 `users(id, name)` 与 `scores(uid, score)` :


``` r
# 用户表
users <- data.frame(
  id = 1:6,
  name = c("Alice", "Bob", "Carol", "David", "Eve", "Frank")
)

# 成绩表
scores <- data.frame(
  uid = c(1, 2, 2, 3, 5, 6, 6),
  score = c(80, 95, 88, 67, 90, 72, 85)
)
```


``` r
left_join(users, scores, by = c("id" = "uid"))   # 左连接
```

```
##   id  name score
## 1  1 Alice    80
## 2  2   Bob    95
## 3  2   Bob    88
## 4  3 Carol    67
## 5  4 David    NA
## 6  5   Eve    90
## 7  6 Frank    72
## 8  6 Frank    85
```

``` r
inner_join(users, scores, by = c("id" = "uid"))  # 内连接
```

```
##   id  name score
## 1  1 Alice    80
## 2  2   Bob    95
## 3  2   Bob    88
## 4  3 Carol    67
## 5  5   Eve    90
## 6  6 Frank    72
## 7  6 Frank    85
```

``` r
right_join(users, scores, by = c("id" = "uid"))  # 右连接
```

```
##   id  name score
## 1  1 Alice    80
## 2  2   Bob    95
## 3  2   Bob    88
## 4  3 Carol    67
## 5  5   Eve    90
## 6  6 Frank    72
## 7  6 Frank    85
```

``` r
full_join(users, scores, by = c("id" = "uid"))   # 全连接
```

```
##   id  name score
## 1  1 Alice    80
## 2  2   Bob    95
## 3  2   Bob    88
## 4  3 Carol    67
## 5  4 David    NA
## 6  5   Eve    90
## 7  6 Frank    72
## 8  6 Frank    85
```

``` r
semi_join(users, scores, by = c("id" = "uid"))   # 过滤出能匹配上的 users（不引入列）
```

```
##   id  name
## 1  1 Alice
## 2  2   Bob
## 3  3 Carol
## 4  5   Eve
## 5  6 Frank
```

``` r
anti_join(users, scores, by = c("id" = "uid"))   # 过滤出匹配不上的 users（找孤儿行）
```

```
##   id  name
## 1  4 David
```

### `rowwise`


``` r
df %>%
  rowwise() %>%
  mutate(
    max_feat = max(c_across(starts_with("feat_")), na.rm = TRUE),
    any_warn = any(c_across(ends_with("_warn")))
  ) %>%
  ungroup()
```

```
## # A tibble: 8 × 10
##      id name  dept      age score feat_a feat_b warn_flag max_feat any_warn
##   <int> <chr> <chr>   <dbl> <dbl>  <dbl>  <dbl> <lgl>        <dbl> <lgl>   
## 1     1 Alice HR         25    80    1.2      5 TRUE             5 FALSE   
## 2     2 Bob   IT         30    95    3.4      6 FALSE            6 FALSE   
## 3     3 Carol Finance    27    67    2.5      7 TRUE             7 FALSE   
## 4     4 David HR         22    88    0.9      5 FALSE            5 FALSE   
## 5     5 Eve   Finance    29    90    4.1      8 FALSE            8 FALSE   
## 6     6 Frank IT         35    72    3.3      7 TRUE             7 FALSE   
## 7     7 Grace Finance    28    85    2.9      6 FALSE            6 FALSE   
## 8     8 Heidi HR         26    60    1.5      5 TRUE             5 FALSE
```
